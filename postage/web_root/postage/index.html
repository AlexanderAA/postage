<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black" />
        <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1.0, maximum-scale=1.0, minimal-ui" />
        
        <title>Postage Log In</title>
        
		<script src="/postage/js/greyspots.js" type="text/javascript"></script>
        <link href="/postage/css/greyspots.css" rel="stylesheet" type="text/css" />
        <link href="/postage/css/postage.css" rel="stylesheet" type="text/css" />
        
        <script>
            var bolCurl = false, bolTutorial = false;
            
            function appendError(data) {
                var errorContainer = document.getElementById('container-error');
                
                data = data.original_response.substring(data.original_response.indexOf('\n') + 1);
                
                if (errorContainer.textContent) {
                    errorContainer.appendChild(document.createElement('br'));
                }
                
                errorContainer.appendChild(document.createTextNode(data));
            }
            
            function login() {
                'use strict';
                var strQueryString = GS.getQueryString(), strConnName = document.getElementById('option-connection').value;
                
                document.getElementById('container-error').textContent = '';
                
                GS.addLoader('login', 'Logging In...');
                GS.ajaxJSON('/postage/auth',
                            'action=login' +
                               '&connname=' + encodeURIComponent(strConnName) +
                               (strConnName === 'custom' ? '&conn=' + encodeURIComponent(document.getElementById('text-custom').value) : '') +
                               '&username=' + encodeURIComponent(document.getElementById('text-username').value) +
                               '&password=' + encodeURIComponent(document.getElementById('text-password').value),
                            function (data, error) {
                    var strRedirect, arrRedirect, i, len, bolFollow;
                    GS.removeLoader('login');
                    
                    if (!error) {
                        localStorage.greyspots_postage_tutorial = bolTutorial;
                        localStorage['greyspots_postage_' + strConnName] = document.getElementById('text-username').value;
                        //localStorage.greyspots_postage_username = document.getElementById('text-username').value;
                        
                        strRedirect = GS.qryGetVal(strQueryString, 'redirect');
                        
                        if (strRedirect) {
                            // we don't want to redirect with a connection index in the url
                            arrRedirect = strRedirect.split('/');
                            
                            // search for connection index
                            for (i = (arrRedirect.length - 1), bolFollow = true; i > -1; i -= 1) {
                                if (!isNaN(parseInt(arrRedirect[i], 10))) {
                                    bolFollow = false;
                                    break;
                                }
                            }
                            
                            if (bolFollow) {
                                window.location = strRedirect;
                            } else {
                                window.location = data.dat;
                            }
                        } else {
                            window.location = data.dat;// + '?cache=no';
                        }
                        
                    } else {
                        appendError(data);
                        document.getElementById('text-password').value = '';
                    }
                });
            }
            
            function appendConnection(connName, strButtons) {
                'use strict';
                var optionControl = document.getElementById('option-connection')
                  , optionElement = document.createElement('gs-option'), strHTML, i, len;
                
                optionElement.setAttribute('value', connName);
                optionElement.textContent = connName;
                optionControl.appendChild(optionElement);
                
                if (!optionControl.value) {
                    optionControl.value = connName;
                }
            }
            
            function getConnections() {
                'use strict';
                var strQueryString = GS.getQueryString(), strConnName = GS.qryGetVal(strQueryString, 'connection');
                document.getElementById('option-connection').innerHTML = '';
                
                // get connection list
                GS.ajaxText('/postage/auth', 'action=list', function (data, error) {
                    var arrConnections, i, len;
                    if (!error) {
                        arrConnections = data.split('\n');
                        for (i = 0, len = arrConnections.length; i < len; i += 1) {
                            appendConnection(arrConnections[i]);
                        }
                        
                        try {
                            document.getElementById('option-connection').value = strConnName || arrConnections[0] || '';
                        } catch (e) {}
                        getUserName();
                        
                    } else {
                        appendError(data);
                    }
                });
                
                // find out if we can dynamically add connection strings
                GS.ajaxText('/postage/auth', 'action=canadd', function (data, error) {
                    var arrConnections, i, len;
                    if (!error) {
                        if (data.trim() === 'true') {
                            //arrConnections = getCookieConnections();
                            //
                            //for (i = 0, len = arrConnections.length; i < len; i += 1) {
                            //    appendConnection(arrConnections[i].connname,
                            //                     '<gs-button onclick="editConnection(\'' + arrConnections[i].cookiename + '\')"></gs-button>');
                            //}
                            
                            var optionControl = document.getElementById('option-connection')
                              , optionElement = document.createElement('gs-option'), strHTML, i, len;
                            
                            optionElement.setAttribute('value', 'custom');
                            optionElement.innerHTML = ml(function () {/*
                                                        <div flex-horizontal>
                                                            <span>custom</span>
                                                            <span>&nbsp;</span>
                                                            <gs-text id="text-custom" value="host= port= dbname= sslmode=prefer" flex></gs-text>
                                                        </div>
                                                    */});
                            optionControl.appendChild(optionElement);
                        }
                        
                    } else {
                        appendError(data);
                    }
                });
            }
            
            function getUserName() {
                'use strict';
                var strConnName = document.getElementById('option-connection').value;
                
                document.getElementById('text-username').value = (localStorage['greyspots_postage_' + strConnName] || '');
                
                if (!evt.touchDevice) {
                    if (document.getElementById('text-username').value) {
                        document.getElementById('text-password').focus();
                    } else {
                        document.getElementById('text-username').focus();
                    }
                }
            }
            
            
            
            window.addEventListener('load', function () {
                var strQueryString = GS.getQueryString(); //, strUnameCookie = GS.getCookie('greyspots_postage_username');
                
                //// if there is a username cookie: set the username input value
                //if (strUnameCookie) {
                //    document.getElementById('text-username').value = decodeURIComponent(strUnameCookie);
                //    
                //// else: place an indicator that the user should get the tutorial after logging in
                //} else {
                //    document.getElementById('text-username').value = 'postgres';
                //    bolTutorial = true;
                //}
                
                //// if we are not on a touch device: put the focus into the first empty control out of "text-username" and "text-password"
                //if (!evt.touchDevice) {
                //    //if (strUnameCookie) {
                //    document.getElementById('text-password').focus();
                //    //} else {
                //    //    document.getElementById('text-username').focus();
                //    //}
                //}
                
                // fill the error element with any error text from the query string (coalesce to empty string)
                document.getElementById('container-error').textContent = GS.qryGetVal(strQueryString, 'error') || '';
                
                // bind keydown for the "text-username" field
                document.getElementById('text-username').addEventListener('keydown', function (event) {
                    if (event.keyCode === 13 && document.getElementById('text-username').value) {
                        login();
                    }
                });
                
                // bind keydown for the "text-password" field
                document.getElementById('text-password').addEventListener('keydown', function (event) {
                    if (event.keyCode === 13 && document.getElementById('text-username').value) {
                        login();
                    }
                });
                
                // bind click for the "button-login" button
                document.getElementById('button-login').addEventListener('click', function () {
                    if (document.getElementById('text-username').value) {
                        login();
                    }
                });
                
                // when the connection optionbox is changed: try to get a username from the cookie
                document.getElementById('option-connection').addEventListener('change', getUserName);
                
                // get connection list
                getConnections();
            });
        </script>
        <style>
            #option-connection gs-option:not(:last-child) {
                border-bottom: 0 none;
            }
            #option-connection gs-option:not(:last-child):not(:first-child) {
                -webkit-border-radius: 0;
                -moz-border-radius: 0;
                -ms-border-radius: 0;
                -o-border-radius: 0;
                border-radius: 0;
            }
            #option-connection gs-option:first-child {
                -webkit-border-radius: 0.25em 0.25em 0 0;
                -moz-border-radius: 0.25em 0.25em 0 0;
                -ms-border-radius: 0.25em 0.25em 0 0;
                -o-border-radius: 0.25em 0.25em 0 0;
                border-radius: 0.25em 0.25em 0 0;
            }
            #option-connection gs-option:last-child {
                -webkit-border-radius: 0 0 0.25em 0.25em;
                -moz-border-radius: 0 0 0.25em 0.25em;
                -ms-border-radius: 0 0 0.25em 0.25em;
                -o-border-radius: 0 0 0.25em 0.25em;
                border-radius: 0 0 0.25em 0.25em;
            }
        </style>
    </head>
    <body>
        <noscript>
            <div id="message-container">
                <div id="line-one">Your browser doesn't allow JavaScript</div>
                <div id="line-two">Please enable Javascript or use a browser that allows Javascript.</div>
            </div>
            <style>
                #message-container {
                    position: fixed;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    text-align: center;
                    z-index: 5000;
                    background: #FFF;
                }
                #line-one {
                    margin-top: 3em;
                    font-weight: 900;
                    font-size: 2em;
                }
                #line-two {
                    font-size: 1.5em;
                    color: #606060;
                }
            </style>
        </noscript>
        <gs-page>
            <gs-body padded>
                <gs-container id="container-login" min-width="768px">
                    <center><h3><b>Login</b></h3></center>
                    <br />
                    
                    <div class="style-bracket-container">
                        <label class="style-bracket-header">Connections</label>
                        <div class="style-bracket-left"></div>
                        <div class="style-bracket-right"></div>
                        
                        <gs-optionbox id="option-connection" no-target mini></gs-optionbox>
                    </div>
                    <br /><br />
                    
                    <div class="style-bracket-container">
                        <label class="style-bracket-header">Credentials</label>
                        <div class="style-bracket-left"></div>
                        <div class="style-bracket-right"></div>
                        
                        <gs-grid reflow-at="350px" gutter>
                            <gs-block>
                                <label for="text-username">Username:</label>
                                <gs-text id="text-username" placeholder="Username" autocapitalize="off" autocorrect="off" autocomplete="off"></gs-text>
                            </gs-block>
                            <gs-block>
                                <label for="text-password">Password:</label>
                                <gs-text id="text-password" placeholder="Password" type="password"></gs-text>
                            </gs-block>
                        </gs-grid>
                    </div>
                    <br /><br />
                    <gs-button id="button-login" jumbo bg-primary>Log In</gs-button>
                    <br /><br />
                </gs-container>
                
                <gs-container min-width="768px">
                    <center id="container-error" style="white-space: pre-wrap;" txt-danger></center>
                </gs-container>
            </gs-body>
        </gs-page>
    </body>
</html>
